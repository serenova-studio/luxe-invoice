<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Invoice Maker</title>
    <meta name="apple-mobile-web-app-title" content="Invoice Maker">
    <link rel="apple-touch-icon" href="icon.png?v=Final">
    <link rel="icon" href="icon.png?v=Final">
    <meta name="theme-color" content="#1E293B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans JP"', 'sans-serif'],
                        serif: ['"Playfair Display"', '"Lora"', 'serif'],
                    },
                    colors: {
                        stone: {
                            50: '#fafaf9', 100: '#f5f5f4', 200: '#e7e5e4', 300: '#d6d3d1',
                            400: '#a8a29e', 500: '#78716c', 600: '#57534e', 700: '#44403c',
                            800: '#292524', 900: '#1c1917',
                        },
                        // Luxury Theme Colors
                        midnight: '#1E293B',
                        gold: '#D4AF37',
                    },
                }
            }
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Sans+JP:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Lora:ital,wght@0,400;0,600;1,400&display=swap"
        rel="stylesheet">

    <style>
        /* Base Styles */
        body,
        html {
            height: 100%;
            overscroll-behavior-y: none;
            /* Prevent Pull-to-Refresh on Mobile App */
        }

        body {
            transition: all 0.3s ease;
            /* Safe Area for iPhone X+ (Bottom) */
            padding-bottom: env(safe-area-inset-bottom);

            /* V10.0: Enforced Physical Safe Area (Top) - 80px as requested "FINAL COMMAND" */
            padding-top: 80px !important;

            overflow-x: hidden;
            background-color: #1E293B;
        }

        /* Themes */
        .theme-luxury {
            --bg-editor: #1E293B;
            --text-editor: #F8FAFC;
            --input-border: #475569;
            --accent: #D4AF37;
            --accent-text: #FDE68A;
        }

        .theme-blue {
            --bg-editor: #F0F9FF;
            --text-editor: #334155;
            --input-border: #CBD5E1;
            --accent: #0284C7;
            --accent-text: #E0F2FE;
        }

        .theme-beige {
            --bg-editor: #FDFBF7;
            --text-editor: #57534E;
            --input-border: #E7E5E4;
            --accent: #A8A29E;
            --accent-text: #FAFAF9;
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {

            input,
            select,
            textarea {
                font-size: 16px !important;
                /* Prevent iOS Zoom */
            }

            .mobile-hidden {
                display: none !important;
            }

            .mobile-visible {
                display: block !important;
            }
        }

        @media (min-width: 769px) {
            .mobile-visible {
                display: none !important;
            }
        }

        /* Print Styles */
        @media print {
            @page {
                margin: 10mm;
                size: A4;
            }

            body {
                background-color: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                height: auto;
                overflow: visible !important;
                padding-top: 0 !important;
                padding-bottom: 0 !important;
                display: block !important;
                /* Fix blank pages */
            }

            .no-print {
                display: none !important;
            }

            .main-container {
                display: block !important;
                /* Fix blank pages */
                height: auto !important;
                overflow: visible !important;
            }

            .editor-panel {
                display: none !important;
            }

            .preview-panel {
                display: block !important;
                /* Fix blank pages */
                height: auto !important;
                overflow: visible !important;
                padding: 0 !important;
                background: white;
                position: static !important;
            }

            .preview-content {
                display: block !important;
                /* Fix blank pages */
                overflow: visible !important;
                height: auto !important;
                padding: 0 !important;
                position: static !important;
            }

            .mobile-tab-bar {
                display: none !important;
            }

            .print-container {
                width: 100% !important;
                max-width: none !important;
                /* Release width */
                min-height: 0 !important;
                /* Release height */
                height: auto !important;
                /* Allow growth */
                transform: none !important;
                /* Reset scale */
                padding: 0 !important;
                margin: 0 !important;
                border: none !important;
                box-shadow: none !important;
                overflow: visible !important;
                position: static !important;
            }

            /* Table Break Logic */
            table {
                page-break-inside: auto;
                width: 100%;
            }

            tr {
                page-break-inside: avoid;
                break-inside: avoid;
            }

            thead {
                display: table-header-group;
            }

            tfoot {
                display: table-footer-group;
            }

            .invoice-footer {
                page-break-inside: avoid;
            }

            /* Page Numbers */
            body {
                counter-reset: page;
            }

            .page-number::after {
                counter-increment: page;
                content: "Page " counter(page);
            }
        }

        /* Utilities */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(150, 150, 150, 0.3);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(150, 150, 150, 0.5);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .accordion-content {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden;
        }

        .mobile-tab-bar {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Native Date Picker Style Overrides */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5);
            /* Make icon visible on dark themes */
            opacity: 0.6;
            cursor: pointer;
        }

        .theme-luxury input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
        }

        .theme-blue input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.2);
        }
    </style>
</head>

<body>
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- V6: AUTO-SCALE HOOK ---
        function useWindowScale() {
            const [scale, setScale] = useState(1);
            useEffect(() => {
                const handleResize = () => {
                    const width = window.innerWidth;
                    if (width < 768) {
                        setScale((width - 32) / 794);
                    } else {
                        setScale(1);
                    }
                };
                window.addEventListener('resize', handleResize);
                handleResize();
                return () => window.removeEventListener('resize', handleResize);
            }, []);
            return scale;
        }

        // --- I18N ---
        const translations = {
            ja: {
                title: "Luxe Invoice", invoice: "請求書", number: "請求書番号", issueDate: "発行日", dueDate: "支払期限",
                billTo: "請求先", clientName: "取引先名", clientAddress: "住所",
                myProfile: "自社情報", name: "名称/氏名", jobTitle: "肩書き", regNo: "登録番号",
                items: "明細および計算", itemName: "品目", qty: "数量", price: "単価", amount: "金額",
                subtotal: "小計", tax: "消費税", withholding: "源泉徴収税", total: "合計", totalDue: "差引請求額",
                bankInfo: "振込先", remarks: "備考", savePdf: "PDF保存", addItem: "行を追加", unit: "円",
                withholdingLabel: "源泉徴収を適用する (10.21%)", images: "画像・印影", uploadLogo: "ロゴをアップロード",
                uploadStamp: "印影・サインをアップロード", remove: "削除", basicInfo: "基本情報", taxSettings: "税設定",
                reset: "リセット", resetConfirm: "初期化しますか？この操作は取り消せません。",
                continued: "（次頁へ続く）", fromPrev: "（前頁より）", page: "ページ",
                tabEdit: "編集", tabPreview: "プレビュー"
            },
            en: {
                title: "Luxe Invoice", invoice: "INVOICE", number: "Invoice No", issueDate: "Date Issued", dueDate: "Due Date",
                billTo: "Bill To", clientName: "Client Name", clientAddress: "Address",
                myProfile: "My Profile", name: "Name", jobTitle: "Title", regNo: "Reg No.",
                items: "Items & Calc", itemName: "Description", qty: "Qty", price: "Unit Price", amount: "Amount",
                subtotal: "Subtotal", tax: "Tax", withholding: "Withholding Tax", total: "Total", totalDue: "Total Amount Due",
                bankInfo: "Bank Info", remarks: "Notes", savePdf: "Save PDF", addItem: "Add Item", unit: "JPY",
                withholdingLabel: "Apply Withholding Tax (10.21%)", images: "Images & Stamp", uploadLogo: "Upload Logo",
                uploadStamp: "Upload Stamp/Sign", remove: "Remove", basicInfo: "Basic Info", taxSettings: "Tax Settings",
                reset: "Reset", resetConfirm: "Are you sure? This cannot be undone.",
                continued: "(Continued)", fromPrev: "(From previous page)", page: "Page",
                tabEdit: "Edit", tabPreview: "Preview"
            }
        };

        // --- ICONS ---
        const Icons = {
            Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
            Plus: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
            Printer: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>,
            ChevronDown: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>,
            Upload: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>,
            Refresh: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>,
            Edit: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
            Eye: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
        };

        // --- COMPONENTS ---

        // V10.0: Native Date Picker (Zero Breakdown Risk)
        // Uses <input type="date"> which launches the OS native picker on mobile.
        const DatePicker = ({ label, value, onChange, themeColor, lang }) => {
            return (
                <div className="flex flex-col gap-1 w-full">
                    <label className={`text-xs font-bold uppercase tracking-wider ${themeColor.label}`}>{label}</label>
                    <input
                        type="date"
                        value={value}
                        onChange={(e) => onChange(e.target.value)}
                        className="w-full bg-transparent border-b py-2 text-base md:text-sm outline-none transition-colors appearance-none"
                        style={{ borderBottomColor: themeColor.border, color: themeColor.text }}
                    />
                </div>
            );
        };

        const ThemeSwitcher = ({ current, onChange }) => {
            const themes = [
                { id: 'luxury', name: 'Luxury', color: '#1E293B', accent: '#D4AF37' },
                { id: 'blue', name: 'Blue', color: '#F0F9FF', accent: '#0284C7' },
                { id: 'beige', name: 'Beige', color: '#FDFBF7', accent: '#A8A29E' },
            ];
            return (
                <div className="flex gap-2 mb-6">
                    {themes.map(t => (
                        <button key={t.id} onClick={() => onChange(t.id)} className={`w-8 h-8 rounded-full border-2 transition-transform hover:scale-110 flex items-center justify-center ${current === t.id ? 'border-indigo-500 shadow-lg scale-110' : 'border-transparent opacity-70'}`} style={{ backgroundColor: t.color }}>
                            <div className="w-2 h-2 rounded-full" style={{ backgroundColor: t.accent }} />
                        </button>
                    ))}
                </div>
            );
        };

        const ToggleSwitch = ({ value, onChange, labelLeft, labelRight }) => (
            <div className="flex items-center justify-center gap-3 select-none cursor-pointer" onClick={() => onChange(value === 'ja' ? 'en' : 'ja')}>
                <span className={`text-xs font-bold transition-colors ${value === 'ja' ? 'text-white' : 'text-stone-400 opacity-60'}`}>{labelLeft}</span>
                <div className="w-12 h-6 rounded-full bg-stone-700/50 backdrop-blur-sm relative p-1 shadow-inner transition-colors duration-300">
                    <div className={`w-4 h-4 rounded-full bg-white shadow-md absolute top-1 transition-all duration-300`} style={{ left: value === 'ja' ? '4px' : '28px' }} />
                </div>
                <span className={`text-xs font-bold transition-colors ${value === 'en' ? 'text-white' : 'text-stone-400 opacity-60'}`}>{labelRight}</span>
            </div>
        );

        const AccordionSection = ({ title, children, color, border, defaultOpen = false }) => {
            const [isOpen, setIsOpen] = useState(defaultOpen);
            return (
                <div className="border-b pb-4" style={{ borderBottomColor: border }}>
                    <button onClick={() => setIsOpen(!isOpen)} className={`w-full flex justify-between items-center text-xs font-bold uppercase tracking-widest py-2 ${color} hover:opacity-80 transition-opacity`}>
                        {title}
                        <div className={`transform transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`}><Icons.ChevronDown /></div>
                    </button>
                    <div className={`accordion-content ${isOpen ? 'max-h-[20000px] opacity-100 pt-4' : 'max-h-0 opacity-0'}`}>
                        <div className="space-y-4">{children}</div>
                    </div>
                </div>
            );
        };

        const ImageUploader = ({ label, imageSrc, onUpload, onRemove, theme }) => {
            const fileInputRef = useRef(null);
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => onUpload(reader.result);
                    reader.readAsDataURL(file);
                }
            };
            return (
                <div className="flex flex-col gap-2">
                    <label className={`text-xs font-bold uppercase tracking-wider ${theme.label}`}>{label}</label>
                    {imageSrc ? (
                        <div className="relative group w-full h-32 bg-black/10 rounded-lg overflow-hidden flex items-center justify-center border border-dashed border-stone-500">
                            <img src={imageSrc} alt="Preview" className="max-h-full max-w-full object-contain" />
                            <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <button onClick={onRemove} className="bg-red-500 text-white px-3 py-1 text-xs rounded-full shadow hover:bg-red-600 transition-colors">Remove</button>
                            </div>
                        </div>
                    ) : (
                        <div onClick={() => fileInputRef.current.click()} className="w-full h-24 border-2 border-dashed rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-white/5 transition-colors gap-2" style={{ borderColor: theme.border, color: theme.label }}>
                            <Icons.Upload /><span className="text-[10px] opacity-70">Click to Upload</span>
                            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} />
                        </div>
                    )}
                </div>
            );
        };

        const Input = ({ label, value, onChange, placeholder, type = "text", theme }) => {
            const handleFocus = (e) => {
                if (type === 'number' && (value === 0 || value === '0')) onChange({ target: { value: '' } });
            };
            const handleChange = (e) => onChange(e);
            return (
                <div className="flex flex-col gap-1 w-full">
                    <label className={`text-xs font-bold uppercase tracking-wider ${theme.label}`}>{label}</label>
                    <input type={type} value={value} onChange={handleChange} onFocus={handleFocus} placeholder={placeholder}
                        className="border-b bg-transparent py-2 outline-none transition-all placeholder-white/20 w-full text-base md:text-sm"
                        style={{ borderBottomColor: theme.border, color: theme.text }} />
                </div>
            );
        };

        const TextArea = ({ label, value, onChange, theme }) => (
            <div className="flex flex-col gap-1 w-full">
                {label && <label className={`text-xs font-bold uppercase tracking-wider ${theme.label}`}>{label}</label>}
                <textarea value={value} onChange={onChange}
                    className="border-b bg-transparent py-1 outline-none transition-all min-h-[60px] resize-none placeholder-white/20 w-full text-base md:text-sm"
                    style={{ borderBottomColor: theme.border, color: theme.text }} />
            </div>
        );

        // --- MAIN APP ---
        const defaults = {
            ja: {
                clientName: "株式会社 サンプルクライアント",
                clientAddress: "〒150-0000 東京都渋谷区神南1-1-1\n渋谷ビル 8F",
                myProfile: {
                    name: "山田 太郎 / 株式会社デザイン",
                    title: "フリーランス デザイナー",
                    address: "〒100-0000 東京都千代田区1-1-1",
                    registrationNumber: "T1234567890123"
                },
                bankInfo: "サンプル銀行 渋谷支店\n普通 1234567\nカ）サンプル"
            },
            en: {
                clientName: "Sample Client Corp",
                clientAddress: "1-2-3 Minato-ku, Tokyo\nJapan",
                myProfile: {
                    name: "Your Name / Company",
                    title: "Freelance Designer",
                    address: "1-1-1 Chiyoda-ku, Tokyo",
                    registrationNumber: "T1234567890123"
                },
                bankInfo: "Sample Bank, Shibuya Branch\nAccount: 1234567\nName: YOUR NAME"
            }
        };

        const initialInvoice = {
            id: crypto.randomUUID(),
            clientName: "株式会社 サンプルクライアント",
            clientAddress: "〒150-0000 東京都渋谷区神南1-1-1\n渋谷ビル 8F",
            issueDate: new Date().toISOString().split('T')[0],
            dueDate: new Date(Date.now() + 12096e5).toISOString().split('T')[0],
            number: `INV-${new Date().getFullYear()}${(new Date().getMonth() + 1).toString().padStart(2, '0')}001`,
            myProfile: {
                name: "山田 太郎 / 株式会社デザイン", title: "フリーランス デザイナー", address: "〒100-0000 東京都千代田区1-1-1",
                email: "contact@example.com", registrationNumber: "T1234567890123"
            },
            bankInfo: "サンプル銀行 渋谷支店\n普通 1234567\nカ）サンプル",
            items: [
                { id: 1, name: "Web Design Service", quantity: 1, price: 150000 },
                { id: 2, name: "Frontend Development", quantity: 1, price: 120000 },
            ],
            remarks: "Thank you for your business.",
            withholdingEnabled: false,
            logoImage: null, stampImage: null
        };

        const themeStyles = {
            luxury: { className: 'theme-luxury', bg: '#1E293B', text: '#F8FAFC', label: 'text-slate-400', border: '#475569', accent: '#D4AF37', accentText: '#FDE68A', previewFont: '"Lora", serif' },
            blue: { className: 'theme-blue', bg: '#F0F9FF', text: '#334155', label: 'text-sky-600', border: '#CBD5E1', accent: '#0284C7', accentText: '#E0F2FE', previewFont: '"Playfair Display", serif' },
            beige: { className: 'theme-beige', bg: '#FDFBF7', text: '#57534E', label: 'text-stone-500', border: '#E7E5E4', accent: '#A8A29E', accentText: '#FAFAF9', previewFont: '"Playfair Display", serif' }
        };

        /** 
         * MAIN COMPONENT 
         */
        function App() {
            const [invoice, setInvoice] = useState(() => {
                const saved = localStorage.getItem('invoice_data_v5');
                return saved ? JSON.parse(saved) : initialInvoice;
            });
            const [lang, setLang] = useState('ja');
            const [theme, setTheme] = useState('luxury');
            const [mobileTab, setMobileTab] = useState('edit');
            const scale = useWindowScale();

            const t = translations[lang];
            const ts = themeStyles[theme];

            useEffect(() => {
                localStorage.setItem('invoice_data_v5', JSON.stringify(invoice));
            }, [invoice]);

            const updateField = (field, value) => setInvoice(p => ({ ...p, [field]: value }));
            const updateProfile = (field, value) => setInvoice(p => ({ ...p, myProfile: { ...p.myProfile, [field]: value } }));
            const updateItem = (id, field, value) => setInvoice(p => ({ ...p, items: p.items.map(i => i.id === id ? { ...i, [field]: value } : i) }));
            const addItem = () => setInvoice(p => ({ ...p, items: [...p.items, { id: crypto.randomUUID(), name: "", quantity: 1, price: 0 }] }));
            const removeItem = (id) => setInvoice(p => ({ ...p, items: p.items.filter(i => i.id !== id) }));

            // V10.0: Aggressive Force Overwrite (Zero conditions)
            // When user switches language, we FORCE overwrite to sample data.
            const switchLanguage = (newLang) => {
                const newDefaults = defaults[newLang];

                setInvoice(prev => {
                    // Force replace all text fields with new defaults
                    return {
                        ...prev,
                        clientName: newDefaults.clientName,
                        clientAddress: newDefaults.clientAddress,
                        bankInfo: newDefaults.bankInfo,
                        myProfile: {
                            ...prev.myProfile,
                            name: newDefaults.myProfile.name,
                            title: newDefaults.myProfile.title,
                            address: newDefaults.myProfile.address
                        }
                    };
                });

                setLang(newLang);
            };

            const handleReset = () => {
                if (window.confirm(t.resetConfirm)) {
                    setInvoice({ ...initialInvoice, id: crypto.randomUUID() });
                }
            };

            const total = useMemo(() => {
                const sub = invoice.items.reduce((sum, i) => sum + (i.price * i.quantity), 0);
                const tax = Math.floor(sub * 0.1);
                const withholding = invoice.withholdingEnabled ? Math.floor(sub * 0.1021) : 0;
                return { sub, tax, withholding, all: sub + tax - withholding };
            }, [invoice.items, invoice.withholdingEnabled]);

            const format = (n) => new Intl.NumberFormat(lang === 'ja' ? 'ja-JP' : 'en-US', { style: 'currency', currency: 'JPY' }).format(n);

            return (
                <div className={`main-container flex flex-col md:flex-row h-full md:h-screen ${ts.className} transition-colors duration-500`}>

                    {/* MOBLIE TAB BAR (Bottom) */}
                    <div className="mobile-tab-bar md:hidden fixed bottom-0 left-0 w-full bg-stone-900 text-white z-50 flex justify-around items-center border-t border-stone-700 shadow-2xl safe-pb">
                        <button onClick={() => setMobileTab('edit')} className={`flex flex-col items-center justify-center w-1/2 py-3 transition-colors ${mobileTab === 'edit' ? 'text-yellow-400' : 'text-stone-400'}`}>
                            <Icons.Edit />
                            <span className="text-[10px] font-bold mt-1 uppercase tracking-wider">{t.tabEdit}</span>
                        </button>
                        <button onClick={() => setMobileTab('preview')} className={`flex flex-col items-center justify-center w-1/2 py-3 transition-colors ${mobileTab === 'preview' ? 'text-yellow-400' : 'text-stone-400'}`}>
                            <Icons.Eye />
                            <span className="text-[10px] font-bold mt-1 uppercase tracking-wider">{t.tabPreview}</span>
                        </button>
                    </div>

                    {/* EDITOR PANEL */}
                    <div className={`editor-panel w-full md:w-1/3 border-r relative z-20 shadow-2xl flex flex-col no-print transition-colors duration-500 shrink-0 h-full ${mobileTab === 'preview' ? 'hidden md:flex' : 'flex'}`}
                        style={{ backgroundColor: ts.bg, color: ts.text, borderColor: ts.border }}>

                        <div className="p-4 md:p-8 pb-4 flex justify-between items-start shrink-0">
                            <div>
                                <h1 className="text-xl md:text-2xl font-serif font-bold tracking-tight mb-4" style={{ color: ts.accent }}>{t.title}</h1>
                                <ThemeSwitcher current={theme} onChange={setTheme} />
                            </div>
                            <div className="flex flex-col items-end gap-3">
                                <ToggleSwitch value={lang} onChange={switchLanguage} labelLeft="JP" labelRight="EN" />
                                <button onClick={handleReset} className="flex items-center gap-1 text-[10px] uppercase tracking-wider border rounded px-2 py-1 opacity-50 hover:opacity-100 transition-all" style={{ borderColor: ts.accent, color: ts.accentText }}>
                                    <Icons.Refresh /> {t.reset}
                                </button>
                            </div>
                        </div>

                        {/* Editor Scroll Area */}
                        <div className="flex-1 overflow-y-auto px-4 md:px-8 pb-24 md:pb-10 space-y-6">
                            <AccordionSection title={t.basicInfo} color={ts.label} border={ts.border} defaultOpen={true}>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <DatePicker label={t.issueDate} value={invoice.issueDate} onChange={d => updateField('issueDate', d)} themeColor={ts} lang={lang} />
                                    <DatePicker label={t.dueDate} value={invoice.dueDate} onChange={d => updateField('dueDate', d)} themeColor={ts} lang={lang} />
                                </div>
                                <Input label={t.number} value={invoice.number} onChange={e => updateField('number', e.target.value)} theme={ts} />
                            </AccordionSection>

                            <AccordionSection title={t.billTo} color={ts.label} border={ts.border} defaultOpen={true}>
                                <Input label={t.clientName} value={invoice.clientName} onChange={e => updateField('clientName', e.target.value)} theme={ts} />
                                <TextArea label={t.clientAddress} value={invoice.clientAddress} onChange={e => updateField('clientAddress', e.target.value)} theme={ts} />
                            </AccordionSection>

                            <AccordionSection title={t.myProfile} color={ts.label} border={ts.border}>
                                <Input label={t.name} value={invoice.myProfile.name} onChange={e => updateProfile('name', e.target.value)} theme={ts} />
                                <Input label={t.jobTitle} value={invoice.myProfile.title} onChange={e => updateProfile('title', e.target.value)} theme={ts} />
                                <Input label={t.regNo} value={invoice.myProfile.registrationNumber} onChange={e => updateProfile('registrationNumber', e.target.value)} theme={ts} />
                                <TextArea label={t.clientAddress} value={invoice.myProfile.address} onChange={e => updateProfile('address', e.target.value)} theme={ts} />
                            </AccordionSection>

                            <AccordionSection title={t.images} color={ts.label} border={ts.border}>
                                <ImageUploader label={t.uploadLogo} imageSrc={invoice.logoImage} onUpload={v => updateField('logoImage', v)} onRemove={() => updateField('logoImage', null)} theme={ts} />
                                <ImageUploader label={t.uploadStamp} imageSrc={invoice.stampImage} onUpload={v => updateField('stampImage', v)} onRemove={() => updateField('stampImage', null)} theme={ts} />
                            </AccordionSection>

                            <AccordionSection title={t.taxSettings} color={ts.label} border={ts.border}>
                                <label className="flex items-center gap-3 cursor-pointer py-2 hover:opacity-80">
                                    <div className={`w-5 h-5 border rounded flex items-center justify-center transition-colors ${invoice.withholdingEnabled ? 'bg-indigo-500 border-indigo-500' : 'border-stone-500'}`}>
                                        {invoice.withholdingEnabled && <svg className="w-3 h-3 text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" /></svg>}
                                    </div>
                                    <input type="checkbox" checked={invoice.withholdingEnabled} onChange={e => updateField('withholdingEnabled', e.target.checked)} className="hidden" />
                                    <span className="text-sm font-medium">{t.withholdingLabel}</span>
                                </label>
                            </AccordionSection>

                            <AccordionSection title={t.items} color={ts.label} border={ts.border} defaultOpen={true}>
                                {invoice.items.map(item => (
                                    <div key={item.id} className="relative p-4 rounded-lg border border-transparent hover:bg-white/5 transition-all group">
                                        <button onClick={() => removeItem(item.id)} className="absolute top-2 right-2 opacity-100 md:opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-500 transition-opacity"><Icons.Trash /></button>
                                        <div className="grid gap-3">
                                            <Input label={t.itemName} value={item.name} onChange={e => updateItem(item.id, 'name', e.target.value)} theme={ts} />
                                            <div className="grid grid-cols-2 gap-3">
                                                <Input label={t.qty} type="number" value={item.quantity} onChange={e => updateItem(item.id, 'quantity', Number(e.target.value))} theme={ts} placeholder="0" />
                                                <Input label={t.price} type="number" value={item.price} onChange={e => updateItem(item.id, 'price', Number(e.target.value))} theme={ts} placeholder="0" />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                <button onClick={addItem} className="flex items-center gap-2 text-sm font-bold opacity-70 hover:opacity-100 transition-opacity my-8 py-2 w-full justify-center border border-dashed rounded" style={{ color: ts.accent, borderColor: ts.border }}><Icons.Plus /> {t.addItem}</button>
                            </AccordionSection>

                            <AccordionSection title={t.bankInfo} color={ts.label} border={ts.border} defaultOpen={true}>
                                <TextArea label="" value={invoice.bankInfo} onChange={e => updateField('bankInfo', e.target.value)} theme={ts} />
                            </AccordionSection>
                            <AccordionSection title={t.remarks} color={ts.label} border={ts.border} defaultOpen={true}>
                                <TextArea label="" value={invoice.remarks} onChange={e => updateField('remarks', e.target.value)} theme={ts} />
                            </AccordionSection>
                        </div>
                    </div>

                    {/* PREVIEW PANEL */}
                    <div className={`preview-panel w-full md:flex-1 flex flex-col h-full bg-stone-100/50 backdrop-blur-3xl overflow-hidden relative ${mobileTab === 'edit' ? 'hidden md:flex' : 'flex'}`}>

                        {/* FIXED TOOLBAR (Sticky Top) */}
                        <div className="no-print sticky top-0 w-full flex justify-end px-4 md:px-8 py-3 bg-white/70 backdrop-blur-md border-b border-stone-200/50 shadow-sm shrink-0 items-center z-50">
                            <button onClick={() => window.print()} className="px-5 py-2 rounded-full shadow-lg hover:shadow-xl hover:scale-105 active:scale-95 transition-all flex items-center gap-2 font-medium text-xs md:text-sm text-white" style={{ backgroundColor: ts.accent, color: theme === 'luxury' ? '#1E293B' : 'white' }}>
                                <Icons.Printer /><span>{t.savePdf}</span>
                            </button>
                        </div>

                        {/* SCROLLABLE INVOICE AREA */}
                        <div className="preview-content flex-1 overflow-x-hidden overflow-y-auto flex flex-col items-center p-4 md:p-8 pb-24 md:pb-20">
                            <div className="print-container w-[210mm] min-h-[297mm] bg-white shadow-2xl p-[15mm] flex flex-col relative text-stone-800 transition-transform duration-300 origin-top bg-white mb-8"
                                style={{ transform: `scale(${scale})`, transformOrigin: 'top center' }}>

                                {/* HEADER */}
                                <header className="flex justify-between items-start mb-12 relative">
                                    <div className="z-10 relative">
                                        <h1 className="text-4xl font-medium mb-2 tracking-wide" style={{ color: theme === 'luxury' ? ts.bg : ts.text, fontFamily: lang === 'en' ? ts.previewFont : '"Noto Sans JP", sans-serif' }}>
                                            {t.invoice}
                                        </h1>
                                        <p className="text-sm font-mono text-stone-500 tracking-wider">NO. {invoice.number}</p>
                                        <p className="text-sm text-stone-400">{invoice.issueDate}</p>
                                    </div>

                                    {/* LOGO & STAMP */}
                                    <div className="text-right relative z-10 w-96 flex flex-col items-end">
                                        {invoice.logoImage && (
                                            <div className="mb-4 w-48 h-20 flex justify-end">
                                                <img src={invoice.logoImage} alt="Logo" className="max-h-full max-w-full object-contain" />
                                            </div>
                                        )}
                                        <div className="relative">
                                            <h2 className="font-bold text-lg mb-1 leading-relaxed">{invoice.myProfile.name}</h2>
                                            <p className="text-sm text-stone-500 whitespace-pre-wrap leading-relaxed">{invoice.myProfile.address}</p>
                                            {invoice.myProfile.registrationNumber && <p className="text-xs text-stone-400 mt-2 leading-relaxed">{t.regNo}: {invoice.myProfile.registrationNumber}</p>}
                                            <div className="absolute top-4 -right-4 w-24 h-24 pointer-events-none mix-blend-multiply opacity-80 flex items-center justify-center z-20">
                                                {invoice.stampImage ? (
                                                    <img src={invoice.stampImage} alt="Stamp" className="max-h-full max-w-full object-contain transform rotate-[-5deg]" />
                                                ) : (
                                                    <div className="w-16 h-16 border-2 border-red-400 rounded-full flex items-center justify-center text-red-400 opacity-20 transform rotate-[-15deg]">
                                                        <span className="text-xs">Stamp</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </header>

                                {/* BODY Content */}
                                <div className="grid grid-cols-2 gap-12 mb-12">
                                    <div>
                                        <span className="text-xs font-bold text-stone-400 uppercase tracking-widest block mb-4">{t.billTo}</span>
                                        <h2 className="text-xl font-medium mb-3 leading-relaxed">{invoice.clientName} {lang === 'ja' && '御中'}</h2>
                                        <p className="text-sm text-stone-600 whitespace-pre-wrap leading-relaxed">{invoice.clientAddress}</p>
                                    </div>
                                    <div className="text-right flex flex-col justify-end">
                                        <div className="mb-2">
                                            <span className="text-xs font-bold text-stone-400 uppercase tracking-widest mr-4">
                                                {invoice.withholdingEnabled ? t.totalDue : t.total}
                                            </span>
                                            <span className="text-3xl font-bold border-b-2 pb-1" style={{ borderColor: theme === 'luxury' ? ts.accent : ts.bg, color: ts.bg }}>
                                                {format(total.all)}
                                            </span>
                                        </div>
                                        <p className="text-sm text-stone-500 font-mono">{t.dueDate}: {invoice.dueDate}</p>
                                    </div>
                                </div>

                                {/* TABLE */}
                                <div className="mb-12">
                                    <table className="w-full text-left">
                                        <thead>
                                            <tr className="border-b" style={{ borderColor: theme === 'luxury' ? ts.accent : ts.border }}>
                                                <th className="py-3 text-xs font-bold text-stone-400 uppercase tracking-widest w-1/2">{t.itemName}</th>
                                                <th className="py-3 text-xs font-bold text-stone-400 uppercase tracking-widest text-right">{t.qty}</th>
                                                <th className="py-3 text-xs font-bold text-stone-400 uppercase tracking-widest text-right">{t.price}</th>
                                                <th className="py-3 text-xs font-bold text-stone-400 uppercase tracking-widest text-right">{t.amount}</th>
                                            </tr>
                                        </thead>
                                        <tfoot className="hidden print:table-footer-group text-stone-300 text-xs italic">
                                            <tr><td colSpan="4" className="pt-2 text-right">{t.continued}</td></tr>
                                        </tfoot>
                                        <tbody className="divide-y divide-stone-100">
                                            <tr className="hidden print:table-row empty:hidden"><td colSpan="4" className="text-stone-300 text-xs italic pb-2">{t.fromPrev}</td></tr>
                                            {invoice.items.map(item => (
                                                <tr key={item.id} className="text-sm">
                                                    <td className="py-4 text-stone-800 font-medium leading-relaxed">{item.name}</td>
                                                    <td className="py-4 text-stone-600 text-right font-mono">{item.quantity}</td>
                                                    <td className="py-4 text-stone-600 text-right font-mono">{format(item.price)}</td>
                                                    <td className="py-4 text-stone-900 text-right font-mono font-medium">{format(item.price * item.quantity)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                {/* FOOTER */}
                                <div className="invoice-footer mt-auto">
                                    <div className="flex justify-end mb-16">
                                        <div className="w-1/2 space-y-3">
                                            <div className="flex justify-between text-sm text-stone-600">
                                                <span>{t.subtotal}</span><span className="font-mono">{format(total.sub)}</span>
                                            </div>
                                            <div className="flex justify-between text-sm text-stone-600">
                                                <span>{t.tax} (10%)</span><span className="font-mono">{format(total.tax)}</span>
                                            </div>
                                            {invoice.withholdingEnabled && (
                                                <div className="flex justify-between text-sm text-red-500 font-medium">
                                                    <span>&#9650; {t.withholding}</span><span className="font-mono">-{format(total.withholding)}</span>
                                                </div>
                                            )}
                                            <div className="flex justify-between text-lg font-bold pt-4 border-t border-stone-200" style={{ color: ts.bg }}>
                                                <span>{invoice.withholdingEnabled ? t.totalDue : t.total}</span><span className="font-serif">{format(total.all)}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-12 pt-8 border-t border-stone-200">
                                        <div>
                                            <span className="text-xs font-bold text-stone-400 uppercase tracking-widest block mb-3">{t.bankInfo}</span>
                                            <p className="text-sm text-stone-600 whitespace-pre-wrap leading-relaxed font-mono">{invoice.bankInfo}</p>
                                        </div>
                                        <div>
                                            <span className="text-xs font-bold text-stone-400 uppercase tracking-widest block mb-3">{t.remarks}</span>
                                            <p className="text-sm text-stone-600 whitespace-pre-wrap leading-relaxed">{invoice.remarks}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>